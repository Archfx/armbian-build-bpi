#
# SPDX-License-Identifier: GPL-2.0
#
# Copyright (c) 2013-2023 Igor Pecovnik, igor@armbian.com
#
# This file is a part of the Armbian Build Framework
# https://github.com/armbian/build/
#
source "${BASH_SOURCE%/*}/include/meson64_common_bpi.inc"
ASOUND_STATE="${ASOUND_STATE:-"asound.state.meson64"}"
CPUMIN=667000
CPUMAX=1908000
GOVERNOR=ondemand

# Determine kernel
case $BRANCH in

	legacy)	
		declare -g KERNEL_MAJOR_MINOR="4.9"
		declare -g KERNELSOURCE='https://github.com/Dangku/amlogic-linux.git'
		declare -g KERNELBRANCH='branch:odroidg12-4.9.y-c4-m5'
		declare -g KERNELPATCHDIR='archive/meson64-4.9'
		declare -g KERNELDIR='linux-bpi-meson64-sm1'
		declare -g KERNEL_IMAGE_TYPE="Image.gz"
		declare -g KERNEL_INSTALL_TYPE="zinstall"
		declare -g EXTRAWIFI=no
		;;
esac

BOOTSOURCE='https://github.com/Dangku/amlogic-u-boot.git'
BOOTBRANCH='branch:odroidg12-v2015.01-c4-m5'
BOOTPATCHDIR='legacy/u-boot-bpi-meson-sm1'
BOOTDIR='u-boot-bpi-meson-sm1'
FORCE_BOOTSCRIPT_UPDATE="yes"
FORCE_UBOOT_UPDATE="yes"
UBOOT_TARGET_MAP=';;sd_fuse/u-boot.bin'

SKIP_EXTERNAL_TOOLCHAINS="no"
UBOOT_USE_GCC='< 4.9'
UBOOT_TOOLCHAIN2="arm-none-eabi-:< 5.0"
UBOOT_COMPILER="aarch64-none-elf-"

VENDOR="Bananapi"
VENDORURL="https://www.banana-pi.org/"
VENDORSUPPORT="https://forum.banana-pi.org/"
VENDORPRIVACY="https://www.banana-pi.org/"
VENDORBUGS="https://forum.banana-pi.org/"
VENDORDOCS="https://wiki.banana-pi.org/"
VENDORLOGO="bpi-logo"
ROOTPWD="1234"
MAINTAINER="Dangku"                             # deb signature
MAINTAINERMAIL="dangku@bananapi.com"

function uboot_custom_postprocess()
{
	:
}

function write_uboot_platform()
{
	display_alert "$BOARD" "Writing uboot to image" "info"

	dd if=$1/u-boot.bin of=$2 bs=512 seek=1 conv=fsync > /dev/null 2>&1
}

function add_host_dependencies__mesonsm1_hostdeb() {
	display_alert "$BOARD" "adding legacy build deps" "info"

        declare -g EXTRA_BUILD_DEPS="${EXTRA_BUILD_DEPS} lib32stdc++6 zlib1g:i386 libc6-dev-i386 lib32ncurses5-dev"
}

function extension_finish_config__mesonsm1_kernelconfig() {
	display_alert "$BOARD" "Setting kernel config" "info"

        declare -g LINUXSOURCEDIR="linux-kernel-worktree/${KERNELDIR}"
}

function post_family_tweaks_bsp__mesonsm1_desktop() {
	display_alert "$BOARD" "Installing board tweaks bsp" "info"

	if [[ "$BUILD_DESKTOP" = "yes" ]]; then
		# install desktop application
		mkdir -p "${destination}"/etc/skel
		cp -R "${SRC}"/packages/blobs/bpi-meson-sm1/desktop/skel/. "${destination}"/etc/skel
		
		# install application icons
		mkdir -p "${destination}"/usr/share/icons/armbian
		cp "${SRC}"/packages/blobs/bpi-meson-sm1/desktop/desktop-icons/*.png "${destination}"/usr/share/icons/armbian
	fi
}

function post_family_tweaks__mesonsm1()
{
	display_alert "$BOARD" "Installing board tweaks" "info"
	# replace bpi bootlogo
	if [[ -f "${SDCARD}/boot/boot.bmp" ]]; then
		rm ${SDCARD}/boot/boot.bmp
	fi
	cp ${SRC}/packages/blobs/bpi-meson-sm1/bsp/boot-logo-24.bmp ${SDCARD}/boot/boot-logo.bmp
	
	# copy common board files
	run_host_command_logged rsync -a "${SRC}"/packages/bsp/bpi-meson-sm1/* "${SDCARD}"

	# enable systemd service
	[[ -f "${SDCARD}"/lib/systemd/system/hdmi_resolution.service ]] && chroot_sdcard systemctl --no-reload enable hdmi_resolution.service

	# disable systemd service
	[[ -f "${SDCARD}"/lib/systemd/system/apt-daily.service ]] && disable_systemd_service_sdcard apt-daily.service
	[[ -f "${SDCARD}"/lib/systemd/system/apt-daily.timer ]] && disable_systemd_service_sdcard apt-daily.timer
	[[ -f "${SDCARD}"/lib/systemd/system/apt-daily-upgrade.service ]] && disable_systemd_service_sdcard apt-daily-upgrade.service
	[[ -f "${SDCARD}"/lib/systemd/system/apt-daily-upgrade.timer ]] && disable_systemd_service_sdcard apt-daily-upgrade.timer
}

function post_family_config__mesonsm1_imagedebs(){
	display_alert "${BOARD}" "Adding packages to image" "info"

	# install packages to image
        add_packages_to_image edid-decode yad firefox
	
	# remove packages from image
	# exo-utils
	remove_packages btrfs-progs update-manager 
}

function pre_customize_image__mesonsm1()
{
	display_alert "$BOARD" "Customizing board image" "info"

	# common prebuilt debs
	cp -a ${SRC}/packages/extras-buildpkgs/bananapi/bpi-meson-sm1/common/${RELEASE} ${SDCARD}/tmp/tmp-debs

	chroot $SDCARD /bin/bash -c "dpkg -i --force-bad-version,confdef /tmp/tmp-debs/*.deb"
	chroot $SDCARD /bin/bash -c "apt --fix-broken --option Dpkg::Options::="--force-confdef" install -y"
}
